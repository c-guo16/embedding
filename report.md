<center>
<hr>
<h1>
嵌入式课程大实验 实验报告
</h1>
    郭诚 计75 2016010563<br>
</center>

## 目录


[TOC]



## 基本情况

​		在本次实验中，我在树莓派上进行开发，使用c++下的opencv和SURF算法实现了图像的特征匹配。



## 环境和运行方法

​		树莓派内核版本：

> Linux raspberrypi 5.4.51-v7+ #1333 SMP Mon Aug 10 16:45:19 BST 2020 armv7l GNU/Linux

该实验所用屏幕为ipad，全屏显示待测试原图，用树莓派摄像头贴近屏幕拍摄。

​		运行方法：

在example文件夹下启动http服务器：

> python3 forwarding.py

在embedding文件夹下启动主程序：

> make
> ./main

之后在浏览器访问**http://树莓派ip:9090/** 即可看到输出。

对一张图片生成程序所需要的数据，在datagen文件夹下运行：

> python3 generate.py

生成的数据位于splitted_pic文件夹下。



## 实现分析

#### 1、项目结构

​		项目结构主要分为三部分，对应三个文件夹，分别为

> datagen: 对原图生成项目所需数据，python实现。
>
> embedding: 项目主体文件夹，使用C++实现，其中main.cpp为项目主体代码。
>
> example: http服务器文件夹，使用python实现，在助教提供的示例代码上修改而成。

​		因为我特征匹配部分希望尽可能提高速度采用了C++下的opencv实现，不能和助教提供的python下的http服务器整合成一个项目，因此我在C++特征匹配程序和python服务器之间采用了本地回环的UDP通信。



#### 2、特征匹配算法实现

​		特征匹配算法我采用的是SURF算法，该算法对图像的旋转畸变和噪声具有一定的容忍性，并且实时性也比较强。值得注意的是，项目要求是在大图中寻找小图的位置，大图越大自然越难找，**因此我根据树莓派摄像头和图像显示屏幕的大小关系，将大图按步进式裁剪成了一些小图，在保证树莓派拍到的画面完全包含在某个小图中的前提下让小图尽可能小，而在SURF匹配时，对小图依次匹配，选取匹配到特征点最多的小图。**这样做对SURF算法的准确性和速度都有了一定提高。




#### 3、项目难点和创新点

1. opencv的C++版本在linux下的编译安装可谓神坑，出了无数的问题。
2. 关于图像处理算法速度跟不上摄像头帧率的问题，会导致延迟忽高忽低。最后采用了多线程方式，在一个线程里读摄像头，另一个线程里处理，并且没有加锁，效果还不错。
3. http服务器搭建的问题。因为我程序主体用的是C++，和助教提供的python服务器没法整合成一个。本来试着写了一个C++服务器，但是后来不知道怎么发送图片，还有一大堆请求头之类的问题，就放弃了，采用了程序间本地回环UDP的方式。但是这样肯定会增加树莓派工作负载。提个小小的建议，关于http服务的实现这里，感觉官方的实现可以再说的明白一些，或者减少一些这方面的要求，毕竟这个不是嵌入式课程的主要内容，而且不熟悉http的话工作量还是很大的。
4. 图片的SURF匹配方面，根据ipad的分辨率特化设计，由匹配大图变成了步进式匹配多个小图。



## 系统裁剪

​		该项目的树莓派系统基于官网提供的lite版本（无桌面版），安装了opencv (C++)、pip等一系列软件，删除了一些不必要的软件包，最终大小约3G。



## 功耗测量

​		不运行任何程序，功耗约1w

​		运行实验程序，功耗约为1.8-2w。